$(function () { shareWidget.init() }); window.shareWidget = (function () { var $shareWrap = $('#shareWidgetWrap'), $shareWidget = $shareWrap.find('#shareWidget'), $num = $shareWrap.find('.num'), $tipTxt = $shareWrap.find('.tipTxt'), $loginingTxt = $shareWrap.find('.loginingTxt'), $username = $('#shareWidgetUsername'), $password = $('#shareWidgetPassword'), $textArea = $shareWrap.find('textarea'), isInit = false, defaultStyle = '', iconPath = '', $steps = $shareWidget.find('.step'), step = 0, shareTxtNum = 0, maxLen = 140 - 8, hasShortUrl = false, accesstoken = null, uid = null, num = -1, loginType = null, shareTxt = '', shareTitle = '', additionTxt = '', shareSuccessFn = null, servUrl = 'http://bula.cn/interface/'; $shareWrap.hide(); var getStrLen = function (str) { var num = [str.match(/[\x00-\xff]/g), str.match(/[^\x00-\xff]/g)]; return Math.round((num[0] ? num[0].length / 2 : 0) + (num[1] ? num[1].length : 0)) }, resetStep = function () { $steps.eq(step).hide(); step = 0; if ($shareWrap.find('.type li').length == 1) { shareWidget.next() } shareTxt = '', shareTxtNum = 0; hasShortUrl = false }, getShortUrl = function (href, title, success, error) { hasShortUrl = false; $.ajax({ url: servUrl + 'IClientGetShortUrl.ashx', data: { lurl: decodeURIComponent(href) }, dataType: 'jsonp', jsonp: 'cb', success: function (data) { if (!data.error) { if (window.shareKeyword) { shareTxt = '【' + title + '】' + ' 正在直播：' + data.url_short + ' ' + window.shareKeyword } else { shareTxt = '分享了' + title + data.url_short } $tipTxt.html('即将分享' + title + '，请添加对分享内容的评论'); shareTxtNum = (shareTxt + $textArea.val()).length; num = maxLen - shareTxtNum; if (num > 0) { $num.removeClass('numNotPass').html('还可输入' + num + '个字') } else { $num.addClass('numNotPass').html('已超过' + -num + '个字') } $.isFunction(success) && success(); hasShortUrl = true } else { showInfo('请重新登录'); $.isFunction(error) && error() } } }) }, reLogin = function () { accesstoken = null, uid = null; resetStep(); shareWidget.show() }, getUserInfo = function () { }, showInfo = function (info) { alert(info) }; return { appendStyle: function () { }, close: function () { $shareWrap.hide(); $steps.eq(step).hide(); resetStep(); shareTitle = ''; shareSuccessFn = null }, init: function (opts) { $('.btnSinaWeibo').live('click', function () { window.liveTitle = '【NBA全明星三分大赛】'; var shareTitles = window.liveTitle; window.liveTitle && shareWidget.show(shareTitles); return false }); $shareWrap.find('.closeBtn').bind('click', function () { shareWidget.close() }); $shareWrap.find('.loginBtn').bind('click', function () { if (/^\s*$/.test($username.val())) { showInfo('请输入账号'); return false } if (/^\s*$/.test($password.val())) { showInfo('请输入密码'); return false } $loginingTxt.show(); $.ajax({ url: servUrl + 'IClientTokenGet.ashx', data: { uname: $username.val(), upswd: $password.val(), app: 'now' }, dataType: 'jsonp', jsonp: 'cb', success: function (data) { $loginingTxt.hide(); if (!data.error) { accesstoken = data.acct; shareWidget.next() } else { var err = data.error; if (err == '-1' || err == '-2') { showInfo('用户名或密码错误') } else { showInfo('请重新登录'); reLogin() } } } }) }); $shareWrap.find('.shareBtn').bind('click', function () { if (!hasShortUrl) { showInfo('短地址正在获取中，请稍候再分享'); return } if (num < 0) { showInfo('分享内容超过140个字符'); return } var val = $textArea.val(); var shareContent = ''; if (window.shareKeyword) { shareContent = val + ' ——' + shareTxt } else { shareContent = shareTxt + (val ? additionTxt + val : val) } if (accesstoken) { var shareParam = { acct: accesstoken, cont: shareContent }; if (window.SinaWithImg && window.SinaWithImg != '') { shareParam.picUrl = window.SinaWithImg } $.ajax({ url: servUrl + 'IClientSendWeibo.ashx', data: shareParam, dataType: 'jsonp', jsonp: 'cb', success: function (data) { if (!data.error) { $.isFunction(shareSuccessFn) && shareSuccessFn(); showInfo('分享成功'); shareWidget.close() } else { var err = data.error; if (err == '-1' || err == '-6') { showInfo('请重新登录'); reLogin() } else if (err == '-3') { showInfo('分享内容超过140个字符') } else if (err == '-7') { showInfo('已有相同的分享内容') } else { showInfo('请重新分享') } } } }) } else { showInfo('请重新登录'); reLogin() } }); if ($shareWrap.find('.type li').length == 1) { shareWidget.next() } $textArea.bind('touchmove', function (e) { e.preventDefault() }).bind('keyup', function (e) { var val = this.value; num = maxLen - (shareTxt + val).length; num >= 0 ? $num.removeClass('numNotPass').html('还可输入' + num + '个字') : $num.addClass('numNotPass').html('已超过' + -num + '个字') }); $shareWrap.bind('click', function (e) { var tar = e.target || e.srcElement; while (tar !== $shareWrap[0]) { if (tar.id == 'shareWidget') { return true } tar = tar.parentNode } shareWidget.close(); return false }); isInit = true }, next: function () { $steps.eq(step).hide(); $steps.eq(++step).show() }, prev: function () { $steps.eq(step).hide(); $steps.eq(--step).show() }, setStyle: function () { }, setStep: function (stepArr) { }, setLoginType: function () { loginType = 0 }, setMidPos: function () { $shareWidget.css('top', (window.innerHeight - $shareWidget[0].offsetHeight) / 2 + 'px') }, show: function (title, shareSuccess) { if (!isInit) { return this } title && (shareTitle = title); shareSuccessFn = shareSuccess; $username.val(''); $password.val(''); getUserInfo(); accesstoken && shareWidget.next(); getShortUrl(window.location.href, shareTitle); $textArea.val($('#commentInput').val()); $shareWrap.show() } } })();